@startuml

participant "NS16550\n(COM1/2)" as dev
participant "MochiKernel"       as kernel
participant "drv-ns16550"       as drv

activate drv
ref over drv
    デバイス初期化機能
end ref

kernel <- drv: 割込み監視開始(COM1)
activate kernel
kernel --> drv:
deactivate kernel
kernel <- drv: 割込み監視開始(COM2)
activate kernel
kernel --> drv:
deactivate kernel

kernel <- drv: 割込み有効化(COM1)
activate kernel
kernel --> drv:
deactivate kernel
kernel <- drv: 割込み有効化(COM2)
activate kernel
kernel --> drv:
deactivate kernel

dev /-- drv: 割込み有効化(COM1)
dev /-- drv: 割込み有効化(COM2)

loop
    par
        kernel <- drv: 割込み待ち
        deactivate drv
        activate kernel

        ...
    else
        dev -> kernel: 割込み
    end par

    kernel --> drv:
    deactivate kernel
    activate drv

    kernel <- drv: 割込み完了通知
    activate kernel
    kernel --> drv:
    deactivate kernel

    dev --\ drv: 割込み要因読込み

    loop 保留割込み有り
        alt 要因 == 転送可能
            ref over drv
                デバイス転送機能
            end ref
        else 要因 == データ受信 ||\n 要因 == 受信タイムアウト||\n 要因 == LSR更新
            ref over drv
                デバイス受信機能
            end ref
        else 要因 == MSR更新
            dev --\ drv: MSR読込み
        end alt

        dev --\ drv: 割込み要因読込み
    end loop
end loop

@enduml
